---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# survtabler

<!-- badges: start -->
<!-- badges: end -->

`survival` package in R is great for interactively and flexibly running survival models and evaluate the resulting model. However, it does not "teach" any structure for an efficient workflow, and often leads to imperative programming and long and complicated analysis scripts. The aim of `survtabler` is to make survival analysis fast, concise, and intuitive while keeping the analysis code easy to read. This is achieved by *function-based* workflow, where many typical steps (modeling, graphing, analyses of violations of proportional hazards model) are automated with functions.


## Motivation & example

Let `example_ti` be a simulated survival data.frame with 8,000 individuals who either experienced an outcome 1 or 2. An analyst would be interested on an association between exposures `exposure_2cat` and `exposure_continuous` on two different outcomes (`outcome1` and `outcome2` - for simplicity here the censoring_time for both of them is the same). Associations should be adjusted for age (`age`) and HLA DR-DQ genotype (`hla`) unless models are run only in subgroups defined by the HLA genotype (DR3/4, DR3/3, and DR4/4). 

<details>
<summary> Here is a typical imperative script that analyzes the data in 129 lines </summary> -->

```{r eval = FALSE}
library(dplyr)
library(survival)
library(survtabler)
library(stringr)
library(broom)
library(ggplot2)
library(scales)

# Create subgroups used in analyses
example_ti_hla33 <- example_ti %>% filter(hla == "DR3/3") 
example_ti_hla34 <- example_ti %>% filter(hla == "DR3/4") 
example_ti_hla44 <- example_ti %>% filter(hla == "DR4/4") 

# Make models
model_outcome1_exposure2cat_hla33 <- coxph(formula = Surv(cens_time, outcome1) ~ exposure_2cat + age + sex, data = example_ti_hla33)
model_outcome1_exposure2cat_hla34 <- coxph(formula = Surv(cens_time, outcome1) ~ exposure_2cat + age + sex, data = example_ti_hla34)
model_outcome1_exposure2cat_hla44 <- coxph(formula = Surv(cens_time, outcome1) ~ exposure_2cat + age + sex, data = example_ti_hla44)
model_outcome1_exposurecont_hla33 <- coxph(formula = Surv(cens_time, outcome1) ~ exposure_continuous + age + sex, data = example_ti_hla33)
model_outcome1_exposurecont_hla34 <- coxph(formula = Surv(cens_time, outcome1) ~ exposure_continuous + age + sex, data = example_ti_hla34)
model_outcome1_exposurecont_hla44 <- coxph(formula = Surv(cens_time, outcome1) ~ exposure_continuous + age + sex, data = example_ti_hla44)
model_outcome2_exposure2cat_hla33 <- coxph(formula = Surv(cens_time, outcome2) ~ exposure_2cat + age + sex, data = example_ti_hla33)
model_outcome2_exposure2cat_hla34 <- coxph(formula = Surv(cens_time, outcome2) ~ exposure_2cat + age + sex, data = example_ti_hla34)
model_outcome2_exposure2cat_hla44 <- coxph(formula = Surv(cens_time, outcome2) ~ exposure_2cat + age + sex, data = example_ti_hla44)
model_outcome2_exposurecont_hla33 <- coxph(formula = Surv(cens_time, outcome2) ~ exposure_continuous + age + sex, data = example_ti_hla33)
model_outcome2_exposurecont_hla34 <- coxph(formula = Surv(cens_time, outcome2) ~ exposure_continuous + age + sex, data = example_ti_hla34)
model_outcome2_exposurecont_hla44 <- coxph(formula = Surv(cens_time, outcome2) ~ exposure_continuous + age + sex, data = example_ti_hla44)

#assess models
model_outcome1_exposure2cat_hla33
model_outcome1_exposure2cat_hla34
model_outcome1_exposure2cat_hla44
model_outcome1_exposurecont_hla33
model_outcome1_exposurecont_hla34
model_outcome1_exposurecont_hla44
model_outcome2_exposure2cat_hla33
model_outcome2_exposure2cat_hla34
model_outcome2_exposure2cat_hla44
model_outcome2_exposurecont_hla33
model_outcome2_exposurecont_hla34
model_outcome2_exposurecont_hla44

# Analyze proportional hazards assumptions
cox.zph(model_outcome1_exposure2cat_hla33)
cox.zph(model_outcome1_exposure2cat_hla34)
cox.zph(model_outcome1_exposure2cat_hla44)
cox.zph(model_outcome1_exposurecont_hla33)
cox.zph(model_outcome1_exposurecont_hla34)
cox.zph(model_outcome2_exposure2cat_hla33)
cox.zph(model_outcome2_exposure2cat_hla34)
cox.zph(model_outcome2_exposure2cat_hla44)
cox.zph(model_outcome2_exposurecont_hla33)
cox.zph(model_outcome2_exposurecont_hla34)
cox.zph(model_outcome2_exposurecont_hla44)

# Extract Coefficients
model_outcome1_exposure2cat_hla33_coefs <- tidy(model_outcome1_exposure2cat_hla33) %>% 
  mutate(model = "outcome1_exposure2cat_hla33_coefs")
model_outcome1_exposure2cat_hla34_coefs <- tidy(model_outcome1_exposure2cat_hla34) %>% 
  mutate(model = "outcome1_exposure2cat_hla34_coefs")
model_outcome1_exposure2cat_hla44_coefs <- tidy(model_outcome1_exposure2cat_hla44) %>% 
  mutate(model = "outcome1_exposure2cat_hla44_coefs")
model_outcome1_exposurecont_hla33_coefs <- tidy(model_outcome1_exposurecont_hla33) %>% 
  mutate(model = "outcome1_exposurecont_hla33_coefs")
model_outcome1_exposurecont_hla34_coefs <- tidy(model_outcome1_exposurecont_hla34) %>% 
  mutate(model = "outcome1_exposurecont_hla34_coefs")
model_outcome1_exposurecont_hla44_coefs <- tidy(model_outcome1_exposurecont_hla44) %>% 
  mutate(model = "outcome1_exposurecont_hla44_coefs")
model_outcome2_exposure2cat_hla33_coefs <- tidy(model_outcome2_exposure2cat_hla33) %>% 
  mutate(model = "outcome2_exposure2cat_hla33_coefs")
model_outcome2_exposure2cat_hla34_coefs <- tidy(model_outcome2_exposure2cat_hla34) %>% 
  mutate(model = "outcome2_exposure2cat_hla34_coefs")
model_outcome2_exposure2cat_hla44_coefs <- tidy(model_outcome2_exposure2cat_hla44) %>% 
  mutate(model = "outcome2_exposure2cat_hla44_coefs")
model_outcome2_exposurecont_hla33_coefs <- tidy(model_outcome2_exposurecont_hla33) %>% 
  mutate(model = "outcome2_exposurecont_hla33_coefs")
model_outcome2_exposurecont_hla34_coefs <- tidy(model_outcome2_exposurecont_hla34) %>% 
  mutate(model = "outcome2_exposurecont_hla34_coefs")
model_outcome2_exposurecont_hla44_coefs <- tidy(model_outcome2_exposurecont_hla44) %>% 
  mutate(model = "outcome2_exposurecont_hla44_coefs")

#Merge coefficients
coefficients <- model_outcome1_exposure2cat_hla33_coefs %>% 
  full_join(model_outcome1_exposure2cat_hla34_coefs) %>% 
  full_join(model_outcome1_exposure2cat_hla44_coefs) %>% 
  full_join(model_outcome1_exposurecont_hla33_coefs) %>% 
  full_join(model_outcome1_exposurecont_hla34_coefs) %>% 
  full_join(model_outcome1_exposurecont_hla44_coefs) %>% 
  full_join(model_outcome2_exposure2cat_hla33_coefs) %>% 
  full_join(model_outcome2_exposure2cat_hla34_coefs) %>% 
  full_join(model_outcome2_exposure2cat_hla44_coefs) %>% 
  full_join(model_outcome2_exposurecont_hla33_coefs) %>% 
  full_join(model_outcome2_exposurecont_hla34_coefs) %>% 
  full_join(model_outcome2_exposurecont_hla44_coefs)
  
# Create graph data
coefficients <- coefficients %>%
  filter(term %in% c("exposure_2cat", "exposure_continuous")) %>% 
    mutate(sig = ifelse(p.value < 0.05, 1, 0)) %>% 
    mutate(sig = factor(sig, levels = c(0, 1),
                        labels = c("p>=0.05", "p<0.05"))) %>% 
  mutate(model = str_remove(model, "_coefs")) %>% 
  mutate(model = str_remove(model, "exposure2cat_")) %>% 
  mutate(model = str_remove(model, "exposurecont_")) %>% 
  mutate(outcome = str_extract(model, ".*?_")) %>%
  mutate(outcome = str_remove(outcome, "_")) %>% 
  mutate(hla = str_extract(model, "(?<=_).*")) %>% 
  mutate(hla = case_when(
    hla == "hla33" ~ "HLA DR3/3",
    hla == "hla34" ~ "HLA DR3/4",
    hla == "hla44" ~ "HLA DR4/4"))

# Graph
coefficients %>%
    ggplot(aes(x = term, y = exp(estimate),
               ymin = exp(estimate - 1.96 * std.error),
               ymax = exp(estimate + 1.96 * std.error),
               colour = sig)) +
    geom_pointrange() +
    geom_text(aes(label = paste0(sprintf("%.2f", signif(exp(estimate), 3)), " (",
                                 sprintf("%.2f", signif(exp(estimate - 1.96 * std.error), 3)), ",",
                                 sprintf("%.2f", signif(exp(estimate + 1.96 * std.error), 3)), ")")),
              vjust = -0.5,
              size = 3.75) +
    coord_flip() +
    geom_hline(yintercept = 1, linetype = "dashed", colour = "grey40") +
    ylab("Hazard Ratio") +
    xlab(NULL) +
    theme(legend.position = "none") +
    ggtitle("Association between risk of 2 outcomes and 2 exposures in 3 groups defined by HLA DR genotypes") +
    scale_y_continuous(trans = "log", labels = label_number(max_n = 2)) +
  facet_wrap(~factor(outcome):factor(hla))
```

</details>

Here is how that would be analyzed with survtabler in 15 lines. 

```{r eval = FALSE}
library(survtabler)

#Build a 'survtable' with combinations of survival model data and model formula
survtable_1 <- create_survtable(exposure_vars = c("exposure_2cat", "exposure_continuous"),
                                outcome_vars = c("outcome1", "outcome2"),
                                covariates = "age + sex + hla",
                                submodel_var = "hla",
                                submodel_values = c("DR3/3", "DR3/4", "DR4/4"),
                                time_var = "cens_time",
                                data_name = "example_ti")

#Run all Cox Proportional Hazards models listed in survtable_1
models <- survtable_1 %>% model_survtable()

#Extract coefficients and graph a forrest plot
models %>% get_coefs(c("exposure_2cat", "exposure_continuous")) %>% 
  graph_coefs()

#Get model metadata
models  %>% get_model_meta()

#Catch models that violate the proportional hazards assumption
models  %>% catch_nonph()
```

It takes 88% of less lines of code to write and the code is way easier to read. The advantage of using survtabler is way more obvious when we consider that analyses often need to be refined later. It would be much nicer to e.g. tweak the covariates here in one line than in 12.

## Installation

You can install the development version of `survtabler` from [GitHub](https://github.com/) with:

```{r eval = FALSE}
install.packages("devtools")
devtools::install_github("jkoskenniemi/survtabler")
```

## Example

Below, we go through the steps of the earlier example in more detail.

The first step is to plan and specify, which Survival models are analyzed. `create_survtable()` builds a data.frame that includes each combination of primary exposures of interest (specified in input as `expoure_vars`), outcomes (`outcome_vars`), follow-up time (`time_var`) and analysis data (`data`). Optionally, subgroup analyses can be requested by providing the variable and values that that define subgroup analyses (`submodel_var` and `submodel_values`).

```{r}
library(survtabler)
library(dplyr)

#Specify all combinations of exposure, outcome, time variables and data_name
survtable_1 <- 
  create_survtable(exposure_vars = c("exposure_2cat", "exposure_continuous"),
                 outcome_vars = c("outcome1", "outcome2"),
                 covariates = "age + sex + hla",
                 time_var = "cens_time",
                 submodel_var = "hla",
                 submodel_values = c("DR3/3", "DR3/4", "DR4/4"),
                 data_name = "example_ti")
```


`survtable` includes for each row everything that is needed for survival analyses by `survival::coxph`: data (`data_name`) and model formula (`formula_str`).

```{r}
survtable_1 %>% select(data_name, formula)
```

After the `survtable` has been created, in principle the following steps (`model_survtable()`, `get_coefs()`, `graph_coefs()`, `get_model_metadata()`, `catch_nonph()`, can be automated and included in a single function (to be created). However, they are all are shown here to show the entire process.  

First, each models are fitted and returned as a list
```{r}
models <- survtable_1 %>%  
  model_survtable()
```


And then model coefficients are extracted and a forest plot drawn, ...
```{r}
models  %>%  
  get_coefs(c("exposure_2cat", "exposure_continuous"))  %>%  #Get coefficients for forrest plots
  graph_coefs(title = "**Your title here**") #Draw forest plots
```

... model metadata extracted, ...
```{r}
models  %>%  
  get_model_meta()
```

... and finally models that violate proportionality of the hazards assumption can be caught (the following example has none).
```{r}
models  %>%  
  catch_nonph()
```

